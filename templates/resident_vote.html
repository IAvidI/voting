<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Access Control Participant</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: #f4f4f4;
                color: #333;
            }
            .container {
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                text-align: center;
                max-width: 400px;
                width: 90%;
            }
            h1,
            h2,
            h3 {
                color: #0056b3;
            }
            .section {
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px solid #eee;
            }
            .hidden {
                display: none;
            }
            #visitorInfoResidentView {
                margin-bottom: 20px;
                padding: 10px;
                border: 1px solid #eee;
                border-radius: 5px;
                background-color: #e9f5ff;
                text-align: left;
            }
            .vote-buttons button,
            #submitPurposeBtnClient {
                display: block;
                width: 100%;
                padding: 15px;
                margin-bottom: 10px;
                font-size: 18px;
                border-radius: 5px;
                border: none;
                cursor: pointer;
            }
            .vote-buttons button:disabled {
                background-color: #ccc !important;
                color: #666 !important;
                opacity: 0.7 !important;
                cursor: not-allowed !important;
            }
            #submitPurposeBtnClient {
                background-color: #007bff;
                color: white;
            }
            #submitPurposeBtnClient:disabled {
                background-color: #ccc !important;
                color: #666 !important;
                opacity: 0.7 !important;
                cursor: not-allowed !important;
            }

            /* Active State Styles - Copied from previous good state */
            #allowBtn {
                background-color: #28a745;
                color: white;
            }
            #denyBtn {
                background-color: #dc3545;
                color: white;
            }
            #abstainBtn {
                background-color: #ffc107;
                color: black;
            }

            /* Hover State Styles for Active Buttons */
            #allowBtn:not(:disabled):hover {
                background-color: #218838;
            }
            #denyBtn:not(:disabled):hover {
                background-color: #c82333;
            }
            #abstainBtn:not(:disabled):hover {
                background-color: #e0a800;
            }
            #submitPurposeBtnClient:not(:disabled):hover {
                background-color: #0056b3;
            }

            /* Disabled State Styles - Using IDs for specificity */
            #allowBtn:disabled,
            #denyBtn:disabled,
            #abstainBtn:disabled {
                background-color: #cccccc;
                color: #666666;
                opacity: 0.65;
                cursor: not-allowed;
            }

            #statusMessage,
            #roleStatusMessage {
                margin-top: 15px;
                font-weight: bold;
            }
            #yourVoteDisplay {
                margin-top: 10px;
                font-style: italic;
                color: #0056b3;
            }
            #outcomeDisplayResident,
            #visitorOutcomeMessage {
                margin-top: 20px;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: bold;
            }
            .outcome-granted {
                color: #28a745;
            }
            .outcome-denied {
                color: #dc3545;
            }
            input[type="text"],
            textarea {
                padding: 10px;
                margin-bottom: 15px;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: calc(100% - 22px);
                box-sizing: border-box;
            }
            textarea {
                min-height: 60px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Participant View</h1>
            <p>
                Session ID: <span id="clientSessionId">{{ session_id }}</span>
            </p>
            <p>Your Name: <span id="myNickname"></span></p>
            <p id="roleStatusMessage">Connecting...</p>

            <div id="nicknameSection" class="section">
                <input
                    type="text"
                    id="nicknameInput"
                    placeholder="Enter your name/nickname"
                />
                <button onclick="joinWithNickname()">Join Session</button>
            </div>

            <div id="visitorUiSection" class="section hidden">
                <h2>You are the Visitor</h2>
                <textarea
                    id="visitorPurposeInputClient"
                    placeholder="Please state your purpose of visit here..."
                ></textarea>
                <button
                    id="submitPurposeBtnClient"
                    onclick="submitVisitorPurpose()"
                >
                    Submit Purpose
                </button>
                <p id="visitorOutcomeMessage"></p>
            </div>

            <div id="residentUiSection" class="section hidden">
                <h2>Resident Voting Panel</h2>
                <p>Visitor: <strong id="visitorNameForResident">N/A</strong></p>
                <div id="outcomeDisplayResident"></div>
                <div id="yourVoteDisplay"></div>
                <h3>Visitor Information:</h3>
                <div id="visitorInfoResidentView">
                    <p>
                        <strong>Purpose:</strong>
                        <span id="visitorPurposeTextResidentView"
                            >Waiting...</span
                        >
                    </p>
                    <p>
                        <strong>System Extracted:</strong>
                        <span id="visitorExtractedTextResidentView"
                            >Waiting...</span
                        >
                    </p>
                </div>
                <div class="vote-buttons">
                    <button id="allowBtn" onclick="sendVote('allow')" disabled>
                        Allow Entry
                    </button>
                    <button id="denyBtn" onclick="sendVote('deny')" disabled>
                        Deny Entry
                    </button>
                    <button
                        id="abstainBtn"
                        onclick="sendVote('abstain')"
                        disabled
                    >
                        Abstain
                    </button>
                </div>
            </div>
            <p id="statusMessage"></p>
        </div>

        <script>
            const socket = io();
            const clientSessionIdEl =
                document.getElementById("clientSessionId");
            const currentSessionId = clientSessionIdEl
                ? clientSessionIdEl.textContent
                : null;
            let myCurrentNickname = "";
            let currentUserRole = "unassigned"; // 'unassigned', 'visitor', 'resident'

            // DOM Elements
            const nicknameSectionEl =
                document.getElementById("nicknameSection");
            const visitorUiSectionEl =
                document.getElementById("visitorUiSection");
            const residentUiSectionEl =
                document.getElementById("residentUiSection");
            const roleStatusMessageEl =
                document.getElementById("roleStatusMessage");
            const statusMessageEl = document.getElementById("statusMessage");
            const myNicknameEl = document.getElementById("myNickname");

            // Visitor UI elements
            const visitorPurposeInputClientEl = document.getElementById(
                "visitorPurposeInputClient"
            );
            const submitPurposeBtnClientEl = document.getElementById(
                "submitPurposeBtnClient"
            );
            const visitorOutcomeMessageEl = document.getElementById(
                "visitorOutcomeMessage"
            );

            // Resident UI elements
            const visitorNameForResidentEl = document.getElementById(
                "visitorNameForResident"
            );
            const outcomeDisplayResidentEl = document.getElementById(
                "outcomeDisplayResident"
            );
            const yourVoteDisplayEl =
                document.getElementById("yourVoteDisplay");
            const visitorPurposeTextResidentViewEl = document.getElementById(
                "visitorPurposeTextResidentView"
            );
            const visitorExtractedTextResidentViewEl = document.getElementById(
                "visitorExtractedTextResidentView"
            );
            const voteButtons = document.querySelectorAll(
                ".vote-buttons button"
            );

            function updateUIVisibility(isErrorState = false) {
                // Default to hiding all specific role/action sections
                nicknameSectionEl.style.display = "none"; // More direct control
                visitorUiSectionEl.style.display = "none";
                residentUiSectionEl.style.display = "none";

                if (isErrorState) {
                    nicknameSectionEl.style.display = "block"; // Show for error correction (e.g. nickname taken)
                    // roleStatusMessageEl is usually set by the error handler itself
                    return;
                }

                if (currentUserRole === "visitor") {
                    visitorUiSectionEl.style.display = "block";
                    roleStatusMessageEl.textContent = `Hi ${
                        myCurrentNickname || "Visitor"
                    }. You are the Visitor.`;
                } else if (currentUserRole === "resident") {
                    residentUiSectionEl.style.display = "block";
                    roleStatusMessageEl.textContent = `Hi ${
                        myCurrentNickname || "Resident"
                    }. You are a Resident (Voter).`;
                } else {
                    // currentUserRole === "unassigned"
                    if (myCurrentNickname) {
                        // Nickname has been submitted, user is waiting for role assignment.
                        // Nickname section should remain hidden.
                        roleStatusMessageEl.textContent = `Hi ${myCurrentNickname}. Waiting for admin to assign a role.`;
                    } else {
                        // Initial state, or after an error that cleared nickname, needs to input nickname.
                        nicknameSectionEl.style.display = "block";
                        roleStatusMessageEl.textContent =
                            "Enter nickname to join.";
                    }
                }
            }

            function setVoteButtonsDisabled(disabled) {
                voteButtons.forEach((b) => (b.disabled = disabled));
            }

            function joinWithNickname() {
                const nicknameInputEl =
                    document.getElementById("nicknameInput");
                let tentativeNickname = nicknameInputEl
                    ? nicknameInputEl.value.trim()
                    : "";
                if (!tentativeNickname) {
                    // Keep it simple, server can assign a default if needed or send error
                    statusMessageEl.textContent = "Nickname cannot be empty."; // Inform user
                    return; // Don't proceed if nickname is empty
                }
                // Don't set myCurrentNickname here yet, wait for server confirmation via joined_successfully_waiting_role

                myNicknameEl.textContent = tentativeNickname; // Optimistically display
                nicknameSectionEl.style.display = "none"; // Hide nickname input immediately
                roleStatusMessageEl.textContent = `Joining as ${tentativeNickname}...`;
                statusMessageEl.textContent = ""; // Clear previous errors

                socket.emit("join_session_resident", {
                    session_id: currentSessionId,
                    nickname: tentativeNickname, // Send the nickname
                });
            }

            function submitVisitorPurpose() {
                const purpose = visitorPurposeInputClientEl.value.trim();
                if (purpose) {
                    socket.emit("visitor_submit_purpose", {
                        session_id: currentSessionId,
                        purpose: purpose,
                    });
                    submitPurposeBtnClientEl.disabled = true;
                    visitorPurposeInputClientEl.disabled = true;
                    statusMessageEl.textContent =
                        "Purpose submitted. Waiting for admin to start voting.";
                } else {
                    statusMessageEl.textContent = "Please enter your purpose.";
                }
            }

            function sendVote(voteType) {
                socket.emit("submit_vote", {
                    session_id: currentSessionId,
                    vote_type: voteType,
                });
                setVoteButtonsDisabled(true);
                yourVoteDisplayEl.textContent = `You voted: ${voteType.toUpperCase()}`;
                statusMessageEl.textContent = `Your vote (${voteType.toUpperCase()}) recorded. Waiting for results...`;
            }

            socket.on("connect", () => {
                // If myCurrentNickname is already set (e.g. from a previous incomplete join/refresh),
                // it might try to rejoin or wait. Server logic handles actual join state.
                // For now, assume fresh state on connect for simplicity, or server will guide.
                if (!myCurrentNickname) {
                    // Only if no nickname has been processed yet
                    currentUserRole = "unassigned";
                    updateUIVisibility();
                } else {
                    // If there's a nickname, they might be reconnecting, show waiting message
                    roleStatusMessageEl.textContent = `Reconnected as ${myCurrentNickname}. Waiting for status...`;
                    // Server should resend role if needed on reconnect
                }
            });

            socket.on("joined_successfully_waiting_role", (data) => {
                myCurrentNickname = data.nickname; // Set/confirm from server
                myNicknameEl.textContent = myCurrentNickname;
                currentUserRole = "unassigned"; // Still waiting for role *assignment*
                updateUIVisibility(); // This will now hide nicknameSection because myCurrentNickname is set
                statusMessageEl.textContent = ""; // Clear "Joining..." or previous errors
            });

            socket.on("role_assigned", (data) => {
                myCurrentNickname =
                    myNicknameEl.textContent || data.visitor_nickname || "User"; // Ensure myCurrentNickname is up-to-date
                currentUserRole = data.your_role;
                updateUIVisibility();
                statusMessageEl.textContent = ""; // Clear previous status
                if (currentUserRole === "resident") {
                    visitorNameForResidentEl.textContent =
                        data.visitor_nickname || "N/A";
                    setVoteButtonsDisabled(true);
                    outcomeDisplayResidentEl.textContent = "";
                    yourVoteDisplayEl.textContent = "";
                    // roleStatusMessageEl is already set by updateUIVisibility
                } else if (currentUserRole === "visitor") {
                    visitorPurposeInputClientEl.value = "";
                    visitorPurposeInputClientEl.disabled = false;
                    submitPurposeBtnClientEl.disabled = false;
                    visitorOutcomeMessageEl.textContent = "";
                    // roleStatusMessageEl is already set by updateUIVisibility
                }
            });

            socket.on("purpose_submission_confirmed", (data) => {
                if (currentUserRole === "visitor") {
                    statusMessageEl.textContent =
                        data.status ||
                        "Purpose submitted. Waiting for voting to start.";
                    submitPurposeBtnClientEl.disabled = true;
                    visitorPurposeInputClientEl.disabled = true;
                }
            });

            socket.on("voting_started", (data) => {
                // For Residents
                if (currentUserRole === "resident") {
                    visitorNameForResidentEl.textContent =
                        data.visitor_nickname || "N/A";
                    visitorPurposeTextResidentViewEl.textContent =
                        data.visitor_purpose;
                    visitorExtractedTextResidentViewEl.textContent =
                        data.extracted_info;
                    setVoteButtonsDisabled(false);
                    yourVoteDisplayEl.textContent = "";
                    outcomeDisplayResidentEl.textContent = "";
                    statusMessageEl.textContent =
                        "Voting is now open. Please cast your vote.";
                }
            });

            socket.on("vote_submitted_confirmation", (data) => {
                // For Residents
                if (currentUserRole === "resident") {
                    console.log("Vote confirmed by server:", data.status);
                    // UI update already handled by sendVote()
                }
            });

            socket.on("voting_ended", (data) => {
                // For Residents
                if (currentUserRole === "resident") {
                    statusMessageEl.textContent = `Voting has ended.`;
                    outcomeDisplayResidentEl.textContent = `Outcome: ${data.outcome}`;
                    outcomeDisplayResidentEl.className =
                        data.outcome === "Access Granted"
                            ? "outcome-granted"
                            : "outcome-denied";
                    setVoteButtonsDisabled(true);
                }
            });

            socket.on("visitor_outcome", (data) => {
                // For Visitor
                if (currentUserRole === "visitor") {
                    statusMessageEl.textContent = `Voting has ended.`;
                    visitorOutcomeMessageEl.textContent = `Outcome: ${data.outcome}`;
                    visitorOutcomeMessageEl.className =
                        data.outcome === "Access Granted"
                            ? "outcome-granted"
                            : "outcome-denied";
                    statusMessageEl.textContent = "Process complete.";
                    // Visitor UI might reset or stay on outcome
                }
            });

            socket.on("error", (data) => {
                statusMessageEl.textContent = `Error: ${data.message}`;
            });

            socket.on("nickname_taken_error", (data) => {
                currentUserRole = "unassigned";
                myCurrentNickname = ""; // Clear the bad nickname
                myNicknameEl.textContent = ""; // Clear from display

                updateUIVisibility(true); // Call with error state true

                roleStatusMessageEl.textContent = "Nickname Error!"; // More prominent error at top
                statusMessageEl.textContent = `Error: ${data.message}. Please choose another.`; // Detailed error below

                const nicknameInputEl =
                    document.getElementById("nicknameInput");
                if (nicknameInputEl) {
                    nicknameInputEl.value = ""; // Clear the input field
                    nicknameInputEl.focus();
                }
            });

            socket.on("disconnect", () => {
                roleStatusMessageEl.textContent = "Disconnected from server.";
                statusMessageEl.textContent = "";
                setVoteButtonsDisabled(true); // Disable all interactive elements
                // Optionally hide all sections except a disconnected message
                visitorUiSectionEl.classList.add("hidden");
                residentUiSectionEl.classList.add("hidden");
                nicknameSectionEl.classList.add("hidden");
            });

            const nicknameInputElGlobal =
                document.getElementById("nicknameInput");
            if (nicknameInputElGlobal) {
                nicknameInputElGlobal.addEventListener(
                    "keypress",
                    function (event) {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            joinWithNickname();
                        }
                    }
                );
            }

            // Initial UI state
            updateUIVisibility();
        </script>
    </body>
</html>
