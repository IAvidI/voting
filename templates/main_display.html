<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Access Control - Main Display</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
                color: #333;
            }
            .container {
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            h1,
            h2,
            h3 {
                color: #0056b3;
            }
            #qrCode img {
                border: 1px solid #ddd;
                padding: 5px;
            }
            #thinkingProcess,
            #votingStatus,
            #outcomeArea {
                margin-top: 20px;
                padding: 15px;
                border: 1px solid #eee;
                border-radius: 5px;
                background-color: #e9f5ff;
            }
            .log-message {
                margin-bottom: 5px;
                font-family: monospace;
            }
            button {
                background-color: #007bff;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
            }
            button:hover {
                background-color: #0056b3;
            }
            input[type="text"],
            input[type="number"] {
                padding: 8px;
                margin-right: 5px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .residents-list li {
                list-style-type: decimal;
            }
            .highlight-red {
                font-weight: bold;
                color: #d9534f;
            } /* For denied or errors */
            .highlight-green {
                font-weight: bold;
                color: #28a745;
            } /* For granted */
            .highlight-neutral {
                font-weight: bold;
                color: #0056b3;
            } /* For general important info */
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Adaptive Access Control Simulation</h1>
            <p>
                <strong>Session ID:</strong>
                <span id="sessionIdDisplay" class="highlight-neutral">N/A</span>
            </p>

            <button id="createSessionBtn">Create New Access Session</button>

            <div id="joinSection" style="display: none">
                <h2>1. Residents Join Here:</h2>
                <p>
                    Scan QR Code or go to:
                    <a id="joinLink" href="#" target="_blank"></a>
                </p>
                <div id="qrCode"></div>
                <h3>
                    Connected Residents (<span
                        id="residentCount"
                        class="highlight-neutral"
                        >0</span
                    >):
                </h3>
                <ul id="residentsList"></ul>
            </div>

            <div id="visitorInputSection" style="display: none">
                <h2>2. Visitor Interaction (Admin Input):</h2>
                <div>
                    <label for="visitorPurposeInput"
                        >Visitor's Stated Purpose:</label
                    >
                    <input
                        type="text"
                        id="visitorPurposeInput"
                        value="DHL delivery for Apartment 3"
                        style="width: 300px"
                    />
                </div>
                <div>
                    <label for="timerInput">Voting Timer (seconds):</label>
                    <input
                        type="number"
                        id="timerInput"
                        value="30"
                        min="5"
                        style="width: 60px"
                    />
                </div>
                <button id="startVotingBtn">Initiate Voting Process</button>
            </div>

            <div id="thinkingProcess" style="display: none">
                <h3>System Thinking Process:</h3>
                <div
                    id="thinkingLog"
                    style="
                        max-height: 200px;
                        overflow-y: auto;
                        border: 1px solid #ddd;
                        padding: 5px;
                    "
                ></div>
            </div>

            <div id="votingStatus" style="display: none">
                <h3>Voting Status:</h3>
                <p>
                    Total Residents (n):
                    <strong id="totalN" class="highlight-neutral">0</strong>
                </p>
                <p>
                    Votes Needed for Approval (t):
                    <strong id="thresholdT" class="highlight-neutral">0</strong>
                </p>
                <p>
                    Time Remaining:
                    <strong id="timeRemaining" class="highlight-neutral"
                        >N/A</strong
                    >
                    s
                </p>
                <p>Visitor Purpose: <em id="displayVisitorPurpose"></em></p>
                <p>Extracted Info: <em id="displayExtractedInfo"></em></p>
                <p>
                    Votes Received:
                    <strong id="votesReceived" class="highlight-neutral"
                        >0</strong
                    >
                    /
                    <strong id="totalResidentsForVote" class="highlight-neutral"
                        >0</strong
                    >
                </p>
                <p>
                    Allow:
                    <strong id="allowVotes" class="highlight-green">0</strong> |
                    Deny:
                    <strong id="denyVotes" class="highlight-red">0</strong> |
                    Abstain:
                    <strong id="abstainVotes" class="highlight-neutral"
                        >0</strong
                    >
                    | No Response:
                    <strong id="noResponseVotes" class="highlight-neutral"
                        >0</strong
                    >
                </p>
                <button id="tallyVotesBtn" style="display: none">
                    Manually End Voting & Tally
                </button>
            </div>

            <div id="outcomeArea" style="display: none">
                <h3>Outcome:</h3>
                <p id="finalOutcome"></p>
            </div>
        </div>

        <script>
            const socket = io();
            let currentSessionId = null;
            let votingTimerInterval = null;

            const createSessionBtn =
                document.getElementById("createSessionBtn");
            const joinSection = document.getElementById("joinSection");
            const visitorInputSection = document.getElementById(
                "visitorInputSection"
            );
            const thinkingProcessDiv =
                document.getElementById("thinkingProcess");
            const thinkingLog = document.getElementById("thinkingLog");
            const votingStatusDiv = document.getElementById("votingStatus");
            const outcomeAreaDiv = document.getElementById("outcomeArea");
            const tallyVotesBtn = document.getElementById("tallyVotesBtn");
            const finalOutcomeEl = document.getElementById("finalOutcome");

            function logToThinkingProcess(message, clearPrevious = false) {
                if (clearPrevious) {
                    thinkingLog.innerHTML = "";
                }
                const p = document.createElement("p");
                p.className = "log-message";
                p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                thinkingLog.appendChild(p);
                thinkingLog.scrollTop = thinkingLog.scrollHeight;
            }

            createSessionBtn.onclick = () => {
                socket.emit("create_session");
                createSessionBtn.disabled = true;
                thinkingProcessDiv.style.display = "block";
                logToThinkingProcess(
                    "Admin: Creating new access session...",
                    true
                ); // Clear previous logs
            };

            socket.on("session_created", (data) => {
                currentSessionId = data.session_id;
                document.getElementById("sessionIdDisplay").textContent =
                    currentSessionId;
                document.getElementById(
                    "qrCode"
                ).innerHTML = `<img src="data:image/png;base64,${data.qr_code}" alt="QR Code">`;
                const joinLinkEl = document.getElementById("joinLink");
                joinLinkEl.href = data.join_url;
                joinLinkEl.textContent = data.join_url;
                joinSection.style.display = "block";
                visitorInputSection.style.display = "block";
                createSessionBtn.style.display = "none";
                document.getElementById("startVotingBtn").disabled = false; // Ensure it's enabled for first round

                logToThinkingProcess(
                    `System: Session <strong class="highlight-neutral">${currentSessionId}</strong> created. QR code displayed for residents to join.`
                );
            });

            socket.on("resident_joined_notification", (data) => {
                document.getElementById("residentCount").textContent =
                    data.resident_count;
                const listItem = document.createElement("li");
                listItem.id = `res-${data.sid}`;
                listItem.textContent = data.nickname;
                document.getElementById("residentsList").appendChild(listItem);
                logToThinkingProcess(
                    `System: Resident '<strong class="highlight-neutral">${data.nickname}</strong>' joined. Total residents: ${data.resident_count}.`
                );
                document.getElementById("totalResidentsForVote").textContent =
                    data.resident_count;
                document.getElementById("noResponseVotes").textContent =
                    data.resident_count -
                    parseInt(
                        document.getElementById("votesReceived").textContent ||
                            0
                    );
            });
            socket.on("resident_left_notification", (data) => {
                document.getElementById("residentCount").textContent =
                    data.resident_count;
                const listItem = document.getElementById(`res-${data.sid}`);
                if (listItem) listItem.remove();
                logToThinkingProcess(
                    `System: Resident '<strong class="highlight-neutral">${data.nickname}</strong>' left. Total residents: ${data.resident_count}.`
                );

                document.getElementById("totalN").textContent =
                    data.resident_count;
                document.getElementById("totalResidentsForVote").textContent =
                    data.resident_count;

                document.getElementById("allowVotes").textContent =
                    data.vote_counts.allow;
                document.getElementById("denyVotes").textContent =
                    data.vote_counts.deny;
                document.getElementById("abstainVotes").textContent =
                    data.vote_counts.abstain;
                document.getElementById("votesReceived").textContent =
                    data.votes_received_count;
                document.getElementById("noResponseVotes").textContent =
                    data.resident_count - data.votes_received_count;
            });

            document.getElementById("startVotingBtn").onclick = () => {
                const purpose = document.getElementById(
                    "visitorPurposeInput"
                ).value;
                const timerDuration = parseInt(
                    document.getElementById("timerInput").value
                );

                if (currentSessionId && purpose && timerDuration > 0) {
                    logToThinkingProcess(
                        `Admin: Initiating voting round for purpose: "${purpose}" with a ${timerDuration}s timer.`,
                        true
                    ); // Clear previous logs
                    socket.emit("start_voting_round", {
                        session_id: currentSessionId,
                        visitor_purpose: purpose,
                        timer_duration: timerDuration,
                    });
                    document.getElementById("startVotingBtn").disabled = true;
                } else {
                    alert(
                        "Session not created, purpose is empty, or timer is invalid."
                    );
                }
            };

            socket.on("voting_parameters_set", (data) => {
                logToThinkingProcess(
                    `System: Visitor stated: '<strong class="highlight-neutral">${data.visitor_purpose}</strong>'.`
                );
                logToThinkingProcess("System: NLP Processing (Simulated)...");
                logToThinkingProcess(
                    `System: Extracted Info: '<strong class="highlight-neutral">${data.extracted_info}</strong>'.`
                );
                logToThinkingProcess(
                    `System: Determining Voting Parameters...`
                );
                logToThinkingProcess(
                    `System: Total Residents (n) = <strong class="highlight-neutral">${data.n}</strong>.`
                );
                logToThinkingProcess(
                    `System: Votes needed for Approval (t) = <strong class="highlight-neutral">${data.t}</strong>.`
                );
                logToThinkingProcess(
                    `System: Initiating Vote: Sending request to ${data.n} residents. Timer set for <strong class="highlight-neutral">${data.timer_duration}s</strong>.`
                );

                votingStatusDiv.style.display = "block";
                document.getElementById("totalN").textContent = data.n;
                document.getElementById("thresholdT").textContent = data.t;
                document.getElementById("displayVisitorPurpose").textContent =
                    data.visitor_purpose;
                document.getElementById("displayExtractedInfo").textContent =
                    data.extracted_info;
                document.getElementById("totalResidentsForVote").textContent =
                    data.n;
                document.getElementById("votesReceived").textContent = 0;
                document.getElementById("allowVotes").textContent = 0;
                document.getElementById("denyVotes").textContent = 0;
                document.getElementById("abstainVotes").textContent = 0;
                document.getElementById("noResponseVotes").textContent = data.n;
                tallyVotesBtn.style.display = "inline-block";
                outcomeAreaDiv.style.display = "none";
                finalOutcomeEl.textContent = "";
                finalOutcomeEl.className = "";

                let timeLeft = data.timer_duration;
                document.getElementById("timeRemaining").textContent = timeLeft;
                if (votingTimerInterval) clearInterval(votingTimerInterval);
                votingTimerInterval = setInterval(() => {
                    timeLeft--;
                    document.getElementById("timeRemaining").textContent =
                        timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(votingTimerInterval);
                        // Timer on client side is just for display, server handles actual timeout
                    }
                }, 1000);

                logToThinkingProcess(`System: Waiting for responses...`);
            });

            socket.on("vote_update", (data) => {
                document.getElementById("votesReceived").textContent =
                    data.votes_received_count;
                document.getElementById("allowVotes").textContent =
                    data.vote_counts.allow;
                document.getElementById("denyVotes").textContent =
                    data.vote_counts.deny;
                document.getElementById("abstainVotes").textContent =
                    data.vote_counts.abstain;
                document.getElementById("noResponseVotes").textContent =
                    parseInt(document.getElementById("totalN").textContent) -
                    data.votes_received_count;

                logToThinkingProcess(
                    `System: Vote received. Current Tally: Allow: ${
                        data.vote_counts.allow
                    }, Deny: ${data.vote_counts.deny}, Abstain: ${
                        data.vote_counts.abstain
                    }. (${data.votes_received_count}/${
                        document.getElementById("totalN").textContent
                    })`
                );
            });

            tallyVotesBtn.onclick = () => {
                if (currentSessionId) {
                    socket.emit("tally_votes", {
                        session_id: currentSessionId,
                        triggered_by_admin: true,
                    });
                    logToThinkingProcess(
                        `Admin: Manually triggered vote tallying.`
                    );
                    tallyVotesBtn.style.display = "none";
                    if (votingTimerInterval) clearInterval(votingTimerInterval);
                    document.getElementById("timeRemaining").textContent =
                        "Ended";
                }
            };

            socket.on("voting_ended_by_server", (data) => {
                // New event for server-triggered tally (e.g. timer)
                logToThinkingProcess(
                    `System: Voting period ended (Timer expired or all votes received).`
                );
                if (votingTimerInterval) clearInterval(votingTimerInterval);
                document.getElementById("timeRemaining").textContent = "Ended";
                tallyVotesBtn.style.display = "none"; // Hide button as tallying is in progress
            });

            socket.on("votes_tallied", (data) => {
                logToThinkingProcess("System: Vote Tally Complete.");
                logToThinkingProcess(
                    `System: Allow: ${data.vote_counts.allow}, Deny: ${data.vote_counts.deny}, Abstain: ${data.vote_counts.abstain}, No Response: ${data.vote_counts.no_response}.`
                );
                logToThinkingProcess(
                    `System: Reconstructing Decision: Comparing Allow votes (${data.vote_counts.allow}) with threshold (t = ${data.t}).`
                );

                finalOutcomeEl.textContent = data.outcome;
                if (data.outcome === "Access Granted") {
                    finalOutcomeEl.className = "highlight-green";
                    logToThinkingProcess(
                        `System: Outcome: <strong class="highlight-green">${data.outcome}</strong>.`
                    );
                } else {
                    finalOutcomeEl.className = "highlight-red";
                    logToThinkingProcess(
                        `System: Outcome: <strong class="highlight-red">${data.outcome}</strong>.`
                    );
                }
                outcomeAreaDiv.style.display = "block";
                tallyVotesBtn.style.display = "none";
                document.getElementById("startVotingBtn").disabled = false; // Re-enable for a new round
                if (votingTimerInterval) clearInterval(votingTimerInterval);
                document.getElementById("timeRemaining").textContent = "N/A";
            });

            socket.on("error", (data) => {
                logToThinking_process(
                    `System Error: <strong class="highlight-red">${data.message}</strong>`
                );
                alert(`Error: ${data.message}`);
            });

            // Initial state
            logToThinkingProcess(
                "System: Main display initialized. Waiting for admin to create a session.",
                true
            );
        </script>
    </body>
</html>
